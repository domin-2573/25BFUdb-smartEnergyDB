# SmartEnergy智慧能源管理系统 - 数据备份恢复策略

## 一、备份策略概述

为确保SmartEnergy智慧能源管理系统数据的安全性和可恢复性，制定以下数据备份与恢复策略。

## 二、备份类型

### 2.1 全量备份（每周）

**备份频率**：每周日凌晨2:00执行  
**备份内容**：整个数据库的所有数据  
**备份方式**：mysqldump导出SQL文件  
**存储位置**：`/backup/smart_energy/full/`  
**保留周期**：保留最近4周的备份

**备份脚本示例**：
```bash
#!/bin/bash
BACKUP_DIR="/backup/smart_energy/full"
DATE=$(date +%Y%m%d)
FILENAME="smart_energy_full_${DATE}.sql"

mysqldump -u root -p smart_energy > ${BACKUP_DIR}/${FILENAME}
gzip ${BACKUP_DIR}/${FILENAME}

# 删除4周前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +28 -delete
```

### 2.2 增量备份（每日）

**备份频率**：每天凌晨3:00执行  
**备份内容**：自上次全量备份或增量备份以来的数据变更  
**备份方式**：MySQL二进制日志（binlog）  
**存储位置**：`/backup/smart_energy/incremental/`  
**保留周期**：保留最近7天的增量备份

**备份脚本示例**：
```bash
#!/bin/bash
BACKUP_DIR="/backup/smart_energy/incremental"
DATE=$(date +%Y%m%d)
FILENAME="smart_energy_incremental_${DATE}.sql"

# 刷新日志
mysqladmin -u root -p flush-logs

# 复制binlog文件
cp /var/lib/mysql/mysql-bin.* ${BACKUP_DIR}/

# 删除7天前的增量备份
find ${BACKUP_DIR} -name "mysql-bin.*" -mtime +7 -delete
```

## 三、备份存储

### 3.1 本地存储

- **主存储路径**：`/backup/smart_energy/`
- **磁盘空间要求**：至少预留数据库大小的3倍空间
- **访问权限**：仅数据库管理员可访问

### 3.2 远程存储（可选）

- **云存储**：阿里云OSS、腾讯云COS等
- **网络存储**：NAS、FTP服务器
- **备份频率**：每周全量备份后自动上传

## 四、恢复流程

### 4.1 全量恢复

**适用场景**：数据库完全损坏或需要恢复到某个时间点

**恢复步骤**：
1. 停止MySQL服务
2. 删除现有数据库（如存在）
3. 创建新数据库
4. 恢复全量备份
5. 应用增量备份（如需要）
6. 启动MySQL服务
7. 验证数据完整性

**恢复命令**：
```bash
# 1. 停止服务
systemctl stop mysql

# 2. 删除数据库（谨慎操作）
mysql -u root -p -e "DROP DATABASE IF EXISTS smart_energy;"

# 3. 创建数据库
mysql -u root -p -e "CREATE DATABASE smart_energy CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 4. 恢复全量备份
gunzip < /backup/smart_energy/full/smart_energy_full_20250101.sql.gz | mysql -u root -p smart_energy

# 5. 应用增量备份（按时间顺序）
mysqlbinlog /backup/smart_energy/incremental/mysql-bin.000001 | mysql -u root -p smart_energy
mysqlbinlog /backup/smart_energy/incremental/mysql-bin.000002 | mysql -u root -p smart_energy

# 6. 启动服务
systemctl start mysql

# 7. 验证数据
mysql -u root -p -e "USE smart_energy; SELECT COUNT(*) FROM 用户表;"
```

### 4.2 部分恢复

**适用场景**：单表数据损坏或误删除

**恢复步骤**：
1. 备份当前表数据（如可能）
2. 从全量备份中提取表数据
3. 恢复表数据
4. 验证数据完整性

**恢复命令**：
```bash
# 从全量备份中提取单表
sed -n '/^-- Table structure for table `用户表`/,/^-- Table structure for table/p' \
    /backup/smart_energy/full/smart_energy_full_20250101.sql > user_table_backup.sql

# 恢复表
mysql -u root -p smart_energy < user_table_backup.sql
```

### 4.3 时间点恢复（PITR）

**适用场景**：恢复到特定时间点的数据状态

**恢复步骤**：
1. 恢复最近的全量备份
2. 应用全量备份时间点到目标时间点的所有增量备份
3. 验证数据

**恢复命令**：
```bash
# 恢复全量备份
gunzip < /backup/smart_energy/full/smart_energy_full_20250101.sql.gz | mysql -u root -p smart_energy

# 恢复到2025-01-05 12:00:00
mysqlbinlog --stop-datetime="2025-01-05 12:00:00" \
    /backup/smart_energy/incremental/mysql-bin.* | mysql -u root -p smart_energy
```

## 五、备份验证

### 5.1 定期验证

- **验证频率**：每周验证一次备份文件
- **验证内容**：
  - 备份文件完整性（文件大小、MD5校验）
  - 备份文件可恢复性（测试恢复）
  - 数据一致性检查

**验证脚本**：
```bash
#!/bin/bash
BACKUP_FILE="/backup/smart_energy/full/smart_energy_full_20250101.sql.gz"

# 检查文件是否存在
if [ ! -f "$BACKUP_FILE" ]; then
    echo "备份文件不存在！"
    exit 1
fi

# 检查文件大小
FILE_SIZE=$(stat -f%z "$BACKUP_FILE")
if [ "$FILE_SIZE" -lt 1000 ]; then
    echo "备份文件异常小，可能损坏！"
    exit 1
fi

# 测试解压
gunzip -t "$BACKUP_FILE"
if [ $? -ne 0 ]; then
    echo "备份文件解压失败，文件可能损坏！"
    exit 1
fi

echo "备份文件验证通过"
```

### 5.2 恢复测试

- **测试频率**：每月执行一次完整恢复测试
- **测试环境**：独立的测试数据库服务器
- **测试内容**：完整恢复流程验证

## 六、监控与告警

### 6.1 备份监控

- **监控项**：
  - 备份任务执行状态
  - 备份文件大小
  - 备份存储空间使用率
  - 备份执行时间

### 6.2 告警机制

- **告警条件**：
  - 备份任务失败
  - 备份文件大小异常
  - 存储空间不足（<20%）
  - 备份执行时间超过阈值

- **告警方式**：
  - 邮件通知
  - 短信通知（紧急情况）
  - 系统日志记录

## 七、应急预案

### 7.1 数据丢失应急

1. **立即停止**所有数据库写入操作
2. **评估损失**：确定数据丢失范围和影响
3. **选择恢复方案**：全量恢复或时间点恢复
4. **执行恢复**：按照恢复流程操作
5. **验证数据**：确保数据完整性和一致性
6. **恢复服务**：重启应用服务
7. **记录事件**：详细记录事件和处理过程

### 7.2 备份失败应急

1. **检查失败原因**：查看备份日志
2. **修复问题**：解决备份失败的根本原因
3. **立即备份**：手动执行备份任务
4. **验证备份**：确保备份文件有效
5. **更新策略**：优化备份策略，防止再次失败

## 八、备份策略优化

### 8.1 性能优化

- 使用`--single-transaction`参数保证数据一致性
- 使用`--quick`参数减少内存占用
- 压缩备份文件节省存储空间
- 并行备份提高备份速度

### 8.2 存储优化

- 定期清理过期备份
- 使用增量备份减少存储空间
- 压缩备份文件
- 考虑使用云存储降低成本

## 九、备份记录

### 9.1 备份日志

每次备份应记录：
- 备份时间
- 备份类型（全量/增量）
- 备份文件路径
- 备份文件大小
- 备份执行状态
- 备份耗时

### 9.2 恢复记录

每次恢复应记录：
- 恢复时间
- 恢复原因
- 恢复类型
- 恢复耗时
- 恢复结果
- 数据验证结果

## 十、总结

本备份恢复策略确保了SmartEnergy智慧能源管理系统数据的安全性和可恢复性，通过定期全量备份和增量备份，结合完善的恢复流程和应急预案，能够有效应对各种数据丢失和系统故障情况。

**关键要点**：
- ✅ 每周全量备份 + 每日增量备份
- ✅ 本地存储 + 远程存储（可选）
- ✅ 定期验证备份文件完整性
- ✅ 完善的恢复流程和应急预案
- ✅ 监控告警机制

