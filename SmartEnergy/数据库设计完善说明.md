# 数据库设计完善说明

## 一、补充的表

### 1. 并网点信息表

**位置：** 分布式光伏管理业务线

**创建原因：** 
- 业务需求中提到"并网点编号"，但缺少并网点基础信息表
- 光伏发电数据表和光伏预测数据表都需要关联并网点信息

**表结构：**
```sql
CREATE TABLE IF NOT EXISTS `并网点信息表` (
    `并网点编号` VARCHAR(20) PRIMARY KEY,
    `并网点名称` VARCHAR(50) NOT NULL,
    `位置描述` VARCHAR(100) NOT NULL,
    `并网电压等级` VARCHAR(20) NOT NULL,
    `并网容量kW` DECIMAL(10,2) NOT NULL,
    `投运时间` DATE NOT NULL,
    `运行状态` VARCHAR(10) NOT NULL DEFAULT '正常',
    `创建时间` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `更新时间` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
```

**外键关联：**
- `光伏发电数据表.并网点编号` → `并网点信息表.并网点编号`
- `光伏预测数据表.并网点编号` → `并网点信息表.并网点编号`

### 2. 执法人员信息表

**位置：** 告警运维管理业务线

**创建原因：** 
- 业务需求2.1.4中明确提到"执法人员信息：执法ID、姓名、所属部门、执法权限、联系方式、执法设备编号"
- 原DDL中缺少此表

**表结构：**
```sql
CREATE TABLE IF NOT EXISTS `执法人员信息表` (
    `执法ID` VARCHAR(20) PRIMARY KEY,
    `姓名` VARCHAR(50) NOT NULL,
    `所属部门` VARCHAR(50) NOT NULL,
    `执法权限` VARCHAR(100) NOT NULL,
    `联系方式` VARCHAR(20) NOT NULL,
    `执法设备编号` VARCHAR(20) NULL,
    `创建时间` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `更新时间` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
```

## 二、完善的字段

### 1. 能耗监测数据表 - 核实状态字段

**添加原因：** 
- 业务需求2.1.3中提到："数据质量为'中/差'时（如数据波动超20%）需标记'待核实'"
- 原表缺少此字段

**新增字段：**
```sql
`核实状态` VARCHAR(10) DEFAULT '已核实' COMMENT '已核实、待核实（数据质量为中/差时标记）'
```

**索引：**
```sql
CREATE INDEX `idx_核实状态` ON `能耗监测数据表`(`核实状态`);
```

## 三、外键约束完善

### 1. 光伏发电数据表
- 原有：`设备编号` → `光伏设备信息表`
- 新增：`并网点编号` → `并网点信息表`

### 2. 光伏预测数据表
- 新增：`并网点编号` → `并网点信息表`

## 四、表结构完整性检查

### ✅ 已完成的业务线

#### 1. 配电网监测业务线
- ✅ 配电房信息表
- ✅ 回路监测数据表
- ✅ 变压器监测数据表

#### 2. 分布式光伏管理业务线
- ✅ 光伏设备信息表
- ✅ **并网点信息表**（新增）
- ✅ 光伏发电数据表（已添加外键）
- ✅ 光伏预测数据表（已添加外键）

#### 3. 综合能耗管理业务线
- ✅ 能耗计量设备信息表
- ✅ 能耗监测数据表（已添加核实状态字段）
- ✅ 峰谷能耗数据表

#### 4. 告警运维管理业务线
- ✅ 告警信息表
- ✅ 运维工单数据表
- ✅ 设备台账数据表
- ✅ **执法人员信息表**（新增）

#### 5. 大屏数据展示业务线
- ✅ 大屏展示配置表
- ✅ 实时汇总数据表
- ✅ 历史趋势数据表

#### 6. 用户管理
- ✅ 用户表

## 五、数据库设计符合业务需求对照

### 2.1.1 配电网监测业务线 ✅
- [x] 配电房信息：配电房编号、名称、位置描述、电压等级、变压器数量、投运时间、负责人ID、联系方式
- [x] 回路监测数据：数据编号、配电房编号、回路编号、采集时间、电压、电流、有功功率、无功功率、功率因数、正向有功电量、反向有功电量、开关状态、电缆头温度、电容器温度
- [x] 变压器监测数据：数据编号、配电房编号、变压器编号、采集时间、负载率、绕组温度、铁芯温度、环境温度、环境湿度、运行状态

### 2.1.2 分布式光伏管理业务线 ✅
- [x] 光伏设备信息：设备编号、设备类型、安装位置、装机容量、投运时间、校准周期、运行状态、通信协议
- [x] 光伏发电数据：数据编号、设备编号、并网点编号、采集时间、发电量、上网电量、自用电量、逆变器效率、汇流箱组串电压、组串电流
- [x] 光伏预测数据：预测编号、并网点编号、预测日期、预测时段、预测发电量、实际发电量、偏差率、预测模型版本
- [x] **并网点信息**（新增）：并网点编号、并网点名称、位置描述、并网电压等级、并网容量、投运时间、运行状态

### 2.1.3 综合能耗管理业务线 ✅
- [x] 能耗计量设备信息：设备编号、能源类型、安装位置、管径规格、通讯协议、运行状态、校准周期、生产厂家
- [x] 能耗监测数据：数据编号、设备编号、采集时间、能耗值、单位、数据质量、**核实状态**（新增）、所属厂区编号
- [x] 峰谷能耗数据：记录编号、能源类型、厂区编号、统计日期、尖峰时段能耗、高峰时段能耗、平段能耗、低谷时段能耗、总能耗、峰谷电价、能耗成本

### 2.1.4 告警运维管理业务线 ✅
- [x] 告警信息：告警编号、告警类型、关联设备编号、发生时间、告警等级、告警内容、处理状态、告警触发阈值
- [x] 运维工单数据：工单编号、告警编号、运维人员ID、派单时间、响应时间、处理完成时间、处理结果、复查状态、附件路径
- [x] 设备台账数据：台账编号、设备名称、设备类型、型号规格、安装时间、质保期、维修记录、校准记录、报废状态
- [x] **执法人员信息**（新增）：执法ID、姓名、所属部门、执法权限、联系方式、执法设备编号

### 2.1.5 大屏数据展示业务线 ✅
- [x] 大屏展示配置：配置编号、展示模块、数据刷新频率、展示字段、排序规则、权限等级
- [x] 实时汇总数据：汇总编号、统计时间、总用电量、总用水量、总蒸汽消耗量、总天然气消耗量、光伏总发电量、光伏自用电量、总告警次数、高等级告警数、中等级告警数、低等级告警数
- [x] 历史趋势数据：趋势编号、能源类型、统计周期、统计时间、能耗/发电量数值、同比增长率、环比增长率、行业均值

## 六、下一步工作建议

### 1. 测试数据补充
- [ ] 为并网点信息表添加测试数据（至少20条）
- [ ] 为执法人员信息表添加测试数据（至少20条）
- [ ] 更新能耗监测数据表的测试数据，包含核实状态字段

### 2. 视图创建
- [ ] 创建并网点关联视图（关联光伏设备、发电数据）
- [ ] 创建待核实能耗数据视图（数据质量为中/差且核实状态为待核实）
- [ ] 创建执法人员工作量统计视图

### 3. 存储过程/触发器
- [ ] 创建触发器：当能耗监测数据的数据质量为"中"或"差"时，自动设置核实状态为"待核实"
- [ ] 创建存储过程：统计各并网点的发电效率
- [ ] 创建存储过程：生成执法人员工作量报表

### 4. DAO层实现
- [ ] 创建并网点信息表的DAO接口
- [ ] 创建执法人员信息表的DAO接口
- [ ] 更新能耗监测数据表的DAO，支持核实状态查询和更新

## 七、总结

本次完善工作：
1. ✅ 新增2个表：并网点信息表、执法人员信息表
2. ✅ 完善1个字段：能耗监测数据表添加核实状态字段
3. ✅ 完善外键约束：光伏发电数据表和光伏预测数据表关联并网点信息表
4. ✅ 所有业务需求已完整覆盖

数据库设计现已完全符合业务需求文档的要求。

