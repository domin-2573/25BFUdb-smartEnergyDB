-- =====================================================
-- 分布式光伏管理业务线测试脚本
-- 测试内容：设备管理、发电数据采集、预测偏差分析
-- =====================================================

USE smart_energy;

-- 1. 插入光伏设备信息测试数据
INSERT IGNORE INTO `光伏设备信息表` (`设备编号`, `设备类型`, `安装位置`, `装机容量kWp`, `投运时间`, `校准周期`, `运行状态`, `通信协议`) VALUES
('TEST_INV_001', '逆变器', '测试屋顶A区', 100.00, '2024-01-15', 12, '正常', 'RS485'),
('TEST_INV_002', '逆变器', '测试屋顶B区', 150.00, '2024-02-20', 12, '正常', '以太网'),
('TEST_COMB_001', '汇流箱', '测试屋顶A区', 300.00, '2024-01-15', 24, '正常', 'RS485'),
('TEST_COMB_002', '汇流箱', '测试屋顶B区', 250.00, '2024-02-20', 24, '正常', 'Lora');

-- 2. 插入并网点信息（如果不存在）
INSERT IGNORE INTO `并网点信息表` (`并网点编号`, `并网点名称`, `并网电压等级`, `最大并网功率kW`, `所属区域`, `投运时间`) VALUES
('TEST_BGD_001', '测试并网点A', '0.4kV', 500.00, '测试园区', '2024-01-15'),
('TEST_BGD_002', '测试并网点B', '10kV', 1000.00, '测试园区', '2024-02-20');

-- 3. 插入正常光伏发电数据
INSERT INTO `光伏发电数据表` (`数据编号`, `设备编号`, `并网点编号`, `采集时间`, `发电量kWh`, `上网电量kWh`, `自用电量kWh`, `逆变器效率`, `汇流箱组串电压V`, `组串电流A`) VALUES
('TEST_PV_NORMAL_001', 'TEST_INV_001', 'TEST_BGD_001', '2026-01-06 08:00:00', 25.50, 15.25, 10.25, 92.50, 650.25, 12.50),
('TEST_PV_NORMAL_002', 'TEST_INV_001', 'TEST_BGD_001', '2026-01-06 09:00:00', 30.75, 18.50, 12.25, 93.20, 655.80, 12.80),
('TEST_PV_NORMAL_003', 'TEST_INV_002', 'TEST_BGD_002', '2026-01-06 08:00:00', 48.25, 30.75, 17.50, 91.80, 660.45, 25.60),
('TEST_PV_NORMAL_004', 'TEST_COMB_001', 'TEST_BGD_001', '2026-01-06 08:00:00', 75.80, 45.50, 30.30, 95.20, 680.90, 35.20);

-- 4. 插入异常光伏发电数据（逆变器效率低于85%）
INSERT INTO `光伏发电数据表` (`数据编号`, `设备编号`, `并网点编号`, `采集时间`, `发电量kWh`, `上网电量kWh`, `自用电量kWh`, `逆变器效率`, `汇流箱组串电压V`, `组串电流A`) VALUES
('TEST_PV_ABNORMAL_001', 'TEST_INV_001', 'TEST_BGD_001', '2026-01-06 10:00:00', 15.20, 9.10, 6.10, 75.80, 620.50, 8.90),
('TEST_PV_ABNORMAL_002', 'TEST_INV_002', 'TEST_BGD_002', '2026-01-06 10:00:00', 25.40, 15.25, 10.15, 82.30, 635.80, 15.60);

-- 5. 插入光伏预测数据
INSERT INTO `光伏预测数据表` (`预测编号`, `并网点编号`, `预测日期`, `预测时段`, `预测发电量kWh`, `实际发电量kWh`, `偏差率`, `预测模型版本`) VALUES
('TEST_PF_001', 'TEST_BGD_001', '2026-01-06', '08:00-09:00', 120.00, 125.50, 4.58, 'V2.0'),
('TEST_PF_002', 'TEST_BGD_001', '2026-01-06', '09:00-10:00', 130.00, 142.75, 9.81, 'V2.0'),
('TEST_PF_003', 'TEST_BGD_001', '2026-01-06', '10:00-11:00', 140.00, 115.20, -17.71, 'V2.0'), -- 偏差超15%
('TEST_PF_004', 'TEST_BGD_002', '2026-01-06', '08:00-09:00', 200.00, 185.60, -7.20, 'V2.0'),
('TEST_PF_005', 'TEST_BGD_002', '2026-01-06', '09:00-10:00', 220.00, 195.40, -11.18, 'V2.0'),
('TEST_PF_006', 'TEST_BGD_002', '2026-01-06', '10:00-11:00', 240.00, 165.80, -30.92, 'V2.0'); -- 偏差超15%

-- 6. 查看测试数据
SELECT '=== 光伏设备信息表测试数据 ===' AS INFO;
SELECT * FROM `光伏设备信息表` WHERE `设备编号` LIKE 'TEST_%';

SELECT '=== 光伏发电数据表测试数据 ===' AS INFO;
SELECT * FROM `光伏发电数据表` WHERE `数据编号` LIKE 'TEST_%';

SELECT '=== 光伏预测数据表测试数据 ===' AS INFO;
SELECT * FROM `光伏预测数据表` WHERE `预测编号` LIKE 'TEST_%';

-- 7. 查看触发的告警
SELECT '=== 光伏业务触发的告警 ===' AS INFO;
SELECT * FROM `告警信息表` WHERE `关联设备编号` LIKE 'TEST_%' ORDER BY `发生时间` DESC LIMIT 10;

-- 8. 测试光伏日发电量统计视图
SELECT '=== 光伏日发电量统计视图 ===' AS INFO;
-- 注意：实际视图名称可能不同，以下为示例查询
SELECT * FROM `v_光伏日发电量统计` WHERE `并网点编号` LIKE 'TEST_%' LIMIT 5;

-- 9. 测试光伏预测偏差视图
SELECT '=== 光伏预测偏差视图 ===' AS INFO;
SELECT * FROM `v_光伏预测偏差` WHERE `并网点编号` LIKE 'TEST_%' LIMIT 5;

-- 10. 测试光伏设备异常汇总视图
SELECT '=== 光伏设备异常汇总视图 ===' AS INFO;
SELECT * FROM `v_光伏设备异常汇总` WHERE `设备编号` LIKE 'TEST_%' LIMIT 5;

-- 11. 清理测试数据
SELECT '=== 清理光伏测试数据 ===' AS INFO;

-- 删除测试告警
-- DELETE FROM `告警信息表` WHERE `关联设备编号` LIKE 'TEST_%';

-- 删除测试数据
DELETE FROM `光伏预测数据表` WHERE `预测编号` LIKE 'TEST_%';
DELETE FROM `光伏发电数据表` WHERE `数据编号` LIKE 'TEST_%';
DELETE FROM `并网点信息表` WHERE `并网点编号` LIKE 'TEST_%';
DELETE FROM `光伏设备信息表` WHERE `设备编号` LIKE 'TEST_%';

SELECT '=== 光伏业务线测试完成 ===' AS INFO;
