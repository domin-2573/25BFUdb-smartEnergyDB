# 数据库连接和登录问题排查指南

## 一、数据库连接测试

### 1. 使用测试接口

启动应用后，访问以下URL测试数据库连接：

```
http://localhost:2008/SmartEnergy/test/db
```

这个接口会返回：
- 数据库连接状态
- 数据库信息（URL、版本、驱动等）
- 用户查询测试结果
- 错误信息（如果有）

### 2. 测试用户查询

访问以下URL查看所有用户：

```
http://localhost:2008/SmartEnergy/test/users
```

### 3. 测试密码加密

访问以下URL测试密码加密功能：

```
http://localhost:2008/SmartEnergy/test/password
```

## 二、登录问题排查步骤

### 步骤1：检查数据库连接

1. 访问 `http://localhost:2008/SmartEnergy/test/db`
2. 查看返回的JSON结果
3. 如果 `success` 为 `false`，说明数据库连接失败

**常见问题：**
- 数据库服务未启动
- 数据库地址、用户名、密码错误
- 网络连接问题
- 防火墙阻止连接

### 步骤2：检查用户数据

1. 访问 `http://localhost:2008/SmartEnergy/test/users`
2. 查看是否有用户数据
3. 检查用户ID `001` 是否存在
4. 检查密码字段是否有值

**如果用户不存在：**
- 执行 `sql/05_测试数据_修正版.sql` 插入测试数据
- 或手动插入用户数据

**如果密码字段为空或格式错误：**
- 执行以下SQL更新密码：
```sql
UPDATE `用户表` 
SET `密码` = '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92' 
WHERE `用户ID` = '001';
```

### 步骤3：检查密码加密

1. 访问 `http://localhost:2008/SmartEnergy/test/password`
2. 查看 `matches` 字段是否为 `true`
3. 查看 `dbPasswordMatches` 字段是否为 `true`

**如果 `dbPasswordMatches` 为 `false`：**
- 说明数据库中的密码哈希值与预期不符
- 需要更新数据库中的密码

### 步骤4：检查拦截器配置

确保 `Config/SecurityConfig.java` 中排除了 `/auth/**` 路径：

```java
.excludePathPatterns(
    "/auth/**",  // 必须包含
    "/SmartEnergy/auth/**",  // 必须包含
    // ... 其他路径
)
```

### 步骤5：检查浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 "Console" 标签
3. 尝试登录，查看是否有错误信息
4. 切换到 "Network" 标签
5. 查看 `/auth/login` 请求的响应

**常见错误：**
- `401 Unauthorized` - 拦截器拦截了请求
- `500 Internal Server Error` - 服务器内部错误
- `404 Not Found` - 路径不存在

### 步骤6：检查服务器日志

查看应用启动日志，查找：
- 数据库连接信息
- MyBatis Mapper扫描信息
- 任何异常堆栈

## 三、常见问题及解决方案

### 问题1：数据库连接失败

**症状：** `test/db` 返回 `success: false`

**解决方案：**
1. 检查 `application.properties` 中的数据库配置
2. 确认数据库服务正在运行
3. 测试网络连接：`ping 121.196.200.165`
4. 检查防火墙设置
5. 确认数据库用户名和密码正确

### 问题2：用户不存在

**症状：** `test/users` 返回空数组或 `test/db` 中 `userQuery` 显示"用户001不存在"

**解决方案：**
```sql
-- 插入测试用户
INSERT INTO `用户表` (`用户ID`, `姓名`, `密码`, `角色`) 
VALUES ('001', '用户1', '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92', '系统管理员');
```

### 问题3：密码不匹配

**症状：** `test/password` 中 `dbPasswordMatches` 为 `false`

**解决方案：**
```sql
-- 更新用户密码
UPDATE `用户表` 
SET `密码` = '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92' 
WHERE `用户ID` = '001';
```

### 问题4：拦截器拦截登录请求

**症状：** 登录请求返回HTML而不是JSON

**解决方案：**
1. 检查 `Config/SecurityConfig.java`
2. 确保 `/auth/**` 在 `excludePathPatterns` 中
3. 重启应用

### 问题5：MyBatis Mapper未扫描

**症状：** `test/db` 返回 "userQuery失败" 或空指针异常

**解决方案：**
1. 检查 `PlantSystemApplication.java` 是否有 `@MapperScan` 注解
2. 如果没有，添加：
```java
@MapperScan("Demo.Dao")
@SpringBootApplication
public class PlantSystemApplication {
    // ...
}
```

## 四、快速诊断命令

### 检查数据库连接（SQL）

```sql
-- 连接到数据库
mysql -h 121.196.200.165 -u jw -p1111 smart_energy

-- 检查用户表
SELECT `用户ID`, `姓名`, `角色`, LENGTH(`密码`) AS 密码长度 FROM `用户表` LIMIT 5;

-- 检查用户001
SELECT `用户ID`, `姓名`, `密码`, `角色` FROM `用户表` WHERE `用户ID` = '001';
```

### 检查应用日志

查看应用启动日志中的：
- `HikariPool` 连接池信息
- `MyBatis` Mapper扫描信息
- 任何异常信息

## 五、测试登录流程

1. **确保应用已启动**
2. **访问测试接口：**
   - `http://localhost:2008/SmartEnergy/test/db` - 检查数据库连接
   - `http://localhost:2008/SmartEnergy/test/users` - 检查用户数据
   - `http://localhost:2008/SmartEnergy/test/password` - 检查密码加密

3. **如果所有测试通过，尝试登录：**
   - 访问：`http://localhost:2008/SmartEnergy/login`
   - 用户ID：`001`
   - 密码：`123456`

4. **如果登录失败，查看：**
   - 浏览器控制台的错误信息
   - 服务器日志的异常堆栈
   - 测试接口返回的详细信息

## 六、调试技巧

### 在AuthService中添加日志

在 `Service/AuthService.java` 的 `login` 方法中添加：

```java
System.out.println("=== 登录调试信息 ===");
System.out.println("用户ID: " + userId);
System.out.println("输入密码: " + password);
User user = userDao.getUserById(userId);
if (user != null) {
    System.out.println("找到用户: " + user.getName());
    System.out.println("数据库密码: " + user.getPassword());
    String hashedPassword = SecurityTool.encryptPassword(password);
    System.out.println("加密后密码: " + hashedPassword);
    System.out.println("密码匹配: " + hashedPassword.equals(user.getPassword()));
} else {
    System.out.println("用户不存在！");
}
```

### 在AuthController中添加日志

在 `Controller/AuthController.java` 的 `login` 方法中添加：

```java
System.out.println("=== 登录请求 ===");
System.out.println("用户ID: " + userId);
System.out.println("密码: " + password);
System.out.println("登录结果: " + loginResult);
```

