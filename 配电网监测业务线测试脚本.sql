-- =====================================================
-- 配电网监测业务线测试脚本
-- 测试内容：数据插入、触发器、存储过程、视图
-- =====================================================

USE smart_energy;

-- 1. 插入配电房信息测试数据（如果不存在）
INSERT IGNORE INTO `配电房信息表` (`配电房编号`, `名称`, `位置描述`, `电压等级`, `变压器数量`, `投运时间`, `负责人ID`, `联系方式`) VALUES
('TEST_PDF_001', '测试总配电房', '测试园区A栋地下1层', '35kV/0.4kV', 2, '2024-01-15', 'TEST_USER_001', '13800000001'),
('TEST_PDF_002', '测试分配电房1', '测试园区B栋1层', '10kV/0.4kV', 1, '2024-03-20', 'TEST_USER_002', '13800000002'),
('TEST_PDF_003', '测试分配电房2', '测试园区C栋2层', '35kV/0.4kV', 3, '2024-05-25', 'TEST_USER_003', '13800000003');

-- 2. 插入正常回路监测数据（不会触发告警）
INSERT INTO `回路监测数据表` (`数据编号`, `配电房编号`, `回路编号`, `采集时间`, `电压kV`, `电流A`, `有功功率kW`, `无功功率kVar`, `功率因数`, `正向有功电量kWh`, `反向有功电量kWh`, `开关状态`, `电缆头温度`, `电容器温度`) VALUES
('TEST_HL_001', 'TEST_PDF_001', 'L1', '2026-01-06 08:00:00', 35.20, 150.50, 5000.25, 1200.75, 0.95, 12500.50, 25.75, '合闸', 45.5, 38.5),
('TEST_HL_002', 'TEST_PDF_001', 'L2', '2026-01-06 08:05:00', 35.10, 180.75, 5200.80, 1100.25, 0.96, 12800.30, 28.90, '合闸', 48.2, 40.1),
('TEST_HL_003', 'TEST_PDF_002', 'L1', '2026-01-06 08:10:00', 10.25, 85.30, 850.45, 150.75, 0.93, 2100.80, 5.25, '分闸', 42.3, 35.8);

-- 3. 插入异常回路监测数据（会触发告警）
-- 电压越限 + 温度过高
INSERT INTO `回路监测数据表` (`数据编号`, `配电房编号`, `回路编号`, `采集时间`, `电压kV`, `电流A`, `有功功率kW`, `无功功率kVar`, `功率因数`, `正向有功电量kWh`, `反向有功电量kWh`, `开关状态`, `电缆头温度`, `电容器温度`) VALUES
('TEST_HL_004', 'TEST_PDF_001', 'L3', '2026-01-06 08:15:00', 37.50, 200.45, 7500.60, 1800.90, 0.94, 18500.75, 45.20, '合闸', 105.2, 80.6),
-- 功率因数过低
('TEST_HL_005', 'TEST_PDF_002', 'L2', '2026-01-06 08:20:00', 10.15, 175.80, 6800.35, 1600.45, 0.80, 16800.40, 38.75, '合闸', 52.8, 41.2);

-- 4. 插入正常变压器监测数据
INSERT INTO `变压器监测数据表` (`数据编号`, `配电房编号`, `变压器编号`, `采集时间`, `负载率`, `绕组温度`, `铁芯温度`, `环境温度`, `环境湿度`, `运行状态`) VALUES
('TEST_BYQ_001', 'TEST_PDF_001', 'BYQ-T001', '2026-01-06 08:00:00', 75.50, 82.5, 75.0, 25.5, 45.2, '正常'),
('TEST_BYQ_002', 'TEST_PDF_001', 'BYQ-T002', '2026-01-06 08:05:00', 68.20, 78.8, 72.5, 26.0, 46.8, '正常'),
('TEST_BYQ_003', 'TEST_PDF_002', 'BYQ-T003', '2026-01-06 08:10:00', 55.75, 72.5, 68.2, 24.8, 42.5, '正常');

-- 5. 插入异常变压器监测数据（会触发告警）
INSERT INTO `变压器监测数据表` (`数据编号`, `配电房编号`, `变压器编号`, `采集时间`, `负载率`, `绕组温度`, `铁芯温度`, `环境温度`, `环境湿度`, `运行状态`) VALUES
('TEST_BYQ_004', 'TEST_PDF_001', 'BYQ-T004', '2026-01-06 08:15:00', 95.80, 105.5, 95.0, 27.5, 48.2, '异常'),
('TEST_BYQ_005', 'TEST_PDF_003', 'BYQ-T005', '2026-01-06 08:20:00', 110.40, 125.2, 115.5, 26.8, 47.5, '异常');

-- 6. 查看插入的数据
SELECT '=== 配电房信息表测试数据 ===' AS INFO;
SELECT * FROM `配电房信息表` WHERE `配电房编号` LIKE 'TEST_%';

SELECT '=== 回路监测数据表测试数据 ===' AS INFO;
SELECT * FROM `回路监测数据表` WHERE `数据编号` LIKE 'TEST_%';

SELECT '=== 变压器监测数据表测试数据 ===' AS INFO;
SELECT * FROM `变压器监测数据表` WHERE `数据编号` LIKE 'TEST_%';

-- 7. 查看触发的告警
SELECT '=== 触发的告警信息 ===' AS INFO;
SELECT * FROM `告警信息表` WHERE `关联设备编号` LIKE 'L3' OR `关联设备编号` LIKE 'L2' OR `关联设备编号` LIKE 'BYQ-T%' ORDER BY `发生时间` DESC LIMIT 10;

-- 8. 测试存储过程（如果存在的话）
-- 注意：根据实际存储过程名称进行调整
SELECT '=== 测试存储过程调用 ===' AS INFO;

-- 9. 测试相关视图
SELECT '=== 测试回路异常数据视图 ===' AS INFO;
-- 如果存在回路异常数据视图，查询测试数据
SELECT * FROM `v_回路异常数据` WHERE `回路编号` LIKE 'L3' OR `回路编号` LIKE 'L2' LIMIT 5;

SELECT '=== 测试配电房运行状态视图 ===' AS INFO;
-- 如果存在配电房运行状态视图，查询测试数据
SELECT * FROM `v_配电房运行状态` WHERE `配电房编号` LIKE 'TEST_%' LIMIT 5;

-- 10. 清理测试数据
SELECT '=== 清理测试数据 ===' AS INFO;

-- 删除测试告警（如果需要的话）
-- DELETE FROM `告警信息表` WHERE `关联设备编号` LIKE 'L3' OR `关联设备编号` LIKE 'L2' OR `关联设备编号` LIKE 'BYQ-T%';

-- 删除测试数据
DELETE FROM `变压器监测数据表` WHERE `数据编号` LIKE 'TEST_%';
DELETE FROM `回路监测数据表` WHERE `数据编号` LIKE 'TEST_%';
DELETE FROM `配电房信息表` WHERE `配电房编号` LIKE 'TEST_%';

SELECT '=== 测试完成 ===' AS INFO;
